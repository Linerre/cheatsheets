\documentclass[10pt,a4paper,landscape]{article}
\input{preamble}

\begin{document}
% Suppress page number for all pages
\pagestyle{empty}

% Each section goes into this env
\begin{multicols*}{3}
\section*{Activation Recrod (AR) and Call Stack}
\begin{itemize}
\item Each procedure has its own AR (a chunk of memory)
\item AR acts as a storage for all the necessary info about the function. It also corresponds to a scope of the function
\item Call stack is data structure used to manage ARs in many imperative langs. In such cases, AR also called \mb{stack frame}
\item Callee's \mb{dynamic link} \textbf{points back} to its caller
\item Returned procedure (its AR) should \emph{not} appear on call stack
\end{itemize}
\section*{Dynamic Link vs Static Link}
\begin{itemize}
\item Links are \mo{dynamic} because they are known only at runtime
\item a procedure's \mo{dynamic link} points to its caller
\item a procedure's \mb{static link} points to where it's \textbf{defined} (its immediate \mb{enclosing scope}, doesn't change during runtime)
\end{itemize}
\section*{Example 1: dynamic links and static links}
\begin{itemize}
\item Suppose the following two \mo{globally} defined procedures
\begin{minipage}{.5\linewidth}
\begin{lstlisting}[language=c]
int sqr(int x) {
  return x * x;
}
\end{lstlisting}
\end{minipage}
\begin{minipage}{.5\linewidth}
\begin{lstlisting}[language=c,xleftmargin=2pt]
int sos(int x, int y) {
  return sqr(x) + sqr(y);
}
\end{lstlisting}
\end{minipage}
\item \texttt{main} calls \texttt{sos} which is being executed (all vars in memory)
\begin{lstlisting}[language=c]
int main(int x) {
  int x = 3, y = 4; // assume vars stored in mem
  sos(x, y); // <-- executing sum of square
  return x * x;
}
\end{lstlisting}
\item box repr. a mem location, a ptr in it points to some other location. Ptrs in regs (\texttt{\%rbp}, \texttt{\%rsp}) may point to a location
  \begin{minipage}{\linewidth}
    \begin{tikzpicture}
      \node(ptr)[ar] {a ptr stored in mem};
      \node[right=5mm of ptr.north east,font=\footnotesize]{
        location start is pointed by a ptr in reg
      };
      \node[right=5mm of ptr.east,font=\footnotesize]{
        ptr stored in mem points to other location
      };
      \draw[->] (ptr.east) -- ([xshift=4mm]ptr.east) -- ([xshift=4mm]ptr.south east);
      \draw[->,color=red!80] ([xshift=4mm]ptr.north east) -- (ptr.north east);
    \end{tikzpicture}
  \end{minipage}
\item Draw the stack frame for \texttt{main} (stack \mr{grows upwards})
\begin{minipage}{\linewidth}
  \centering
  \begin{tikzpicture}
    % main
    \node(main) [ar] {
      static link \\
      args for callee \\
      prev frame ptr \\
      return addr \\
      locals: x, y
    };
    \node(global) [ar,below=0mm of main] { global: main };

    % main's dynamic link points to null
    \fill[color=red!80] ([xshift=-3mm]main.east) circle (2pt);
    \draw[->,color=red!80] ([xshift=-3mm]main.east) -- ([xshift=3mm]main.east)
    -- ([xshift=3mm]global.east) -- (global.east);

    % main's static link points to global
    \fill ([yshift=-2mm,xshift=3mm]main.north west) circle (2pt);
    \draw[->] ([yshift=-2mm,xshift=3mm]main.north west)
    -- ([xshift=-2mm,yshift=-2mm]main.north west)
    -- ([xshift=-2mm]global.west) -- (global.west);
  \end{tikzpicture}
\end{minipage}
\item Draw call stack where \texttt{main} calls \texttt{sos} (it saved \texttt{main}'s RBP)
\begin{minipage}{\linewidth}
  \centering
  \begin{tikzpicture}
    % sos
    \node(sos) [ar, fill=blue!50,fill=blue!20,above=0mm of main] {
      \mb{static link} \\
      args for callee \\
      main's frame ptr \\
      return addr \\
      local vars
    };
    \node(note1) [right=6mm of sos.south east,text width=4cm,font=\footnotesize] {
      \texttt{sos}'s \mo{dynamic link} (saved frame ptr of \texttt{main}) points to \texttt{main}'s \texttt{RBP} location };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]sos.north west) -- ([xshift=-6mm]sos.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{sos} AR};

    \node(note2) [right=6mm of sos.east, yshift=2mm, text
    width=4cm,font=\footnotesize] {
      \texttt{sos}'s frame ptr (usu. in reg) points to the start of this location
      (\texttt{main}'s frame ptr)
    };
    \draw[->,color=red!80]([yshift=-1mm]note2.west) -- ([yshift=1mm]sos.east);

    % main
    \node(main) [ar,below=0mm of sos] {
      \mb{static link} \\
      args for callee \\
      prev frame ptr \\
      return addr \\
      locals: x, y
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]main.north west) -- ([xshift=-6mm]main.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{main} AR};
    \node(note3) [right=6mm of main.east, yshift=-6mm,font=\footnotesize,
    text width=4cm] {
      When control returns from \texttt{sos} to \texttt{main}, \texttt{return addr} tells CPU where to resume the execution in \texttt{main}
    };

    % global
    \node(global) [ar,below=0mm of main] { global: main,sos };

    % dynamic link
    \node[above=0mm of sos.north east,font=\footnotesize,color=red!80]
    {dynamic links};

    % sos -> main
    \fill[color=red!50] ([xshift=-3mm]sos.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]sos.east) -- ([xshift=4mm]sos.east)
    -- ([xshift=4mm,yshift=1mm]main.east) -- ([yshift=1mm]main.east);

    % main -> global
    \fill[color=red!50] ([xshift=-3mm]main.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]main.east) -- ([xshift=4mm]main.east)
    -- ([xshift=4mm]global.east) -- (global.east);

    % static links
    \node[above=0mm of sos.north west,font=\footnotesize,color=blue!50]
    {static links};

    \fill[color=blue!50] ([xshift=4mm,yshift=-2mm]main.north west) circle (2pt);
    \draw[->] ([xshift=4mm,yshift=-2mm]main.north west)
    -- ([xshift=-2mm,yshift=-2mm]main.north west)
    -- ([xshift=-2mm]global.west) -- (global.west);

    \fill[color=blue!50] ([xshift=4mm,yshift=-2mm]sos.north west) circle (2pt);
    \draw[->,color=blue!50] ([xshift=4mm,yshift=-2mm]sos.north west)
    -- ([xshift=-4mm,yshift=-2mm]sos.north west)
    -- ([xshift=-4mm]global.west) -- (global.west);
  \end{tikzpicture}
\end{minipage}
\item Call stack where \texttt{sos} calls \texttt{sqr} (which saved \texttt{sos}'s RBP)
\begin{minipage}{\linewidth}
  \centering
  \begin{tikzpicture}
    % sqr
    \node(sqr) [ar,fill=green!50,fill=green!20,above=0mm of sos] {
      \mb{static link} \\
      args for callee \\
      sos' frame ptr \\
      return addr \\
      local vars
    };
    \node(note0) [right=6mm of sqr.south east,text width=4cm,font=\footnotesize] {
      \texttt{sqr}'s \mo{dynamic link} (saved frame ptr of \texttt{sos}) points to start of \texttt{sos}'s \texttt{RBP} location };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]sqr.north west) -- ([xshift=-6mm]sqr.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{sqr} AR};

    % sos
    \node(sos) [ar, fill=blue!50,fill=blue!20,above=0mm of main] {
      \mb{static link} \\
      args for callee \\
      main's frame ptr \\
      return addr \\
      local vars
    };
    \node(note1) [right=6mm of sos.south east,text width=4cm,font=\footnotesize] {
      \texttt{sos}'s \mo{dynamic link} (saved frame ptr of \texttt{main}) points to start of \texttt{main}'s \texttt{RBP} location };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]sos.north west) -- ([xshift=-6mm]sos.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{sos} AR};

    % main
    \node(main) [ar,below=0mm of sos] {
      \mb{static link} \\
      args for callee \\
      prev frame ptr \\
      return addr \\
      locals: x, y
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]main.north west) -- ([xshift=-6mm]main.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{main} AR};

    % global
    \node(global) [ar,below=0mm of main] {
      global:\\
      main, sos, sqr
    };

    %dynamic links
    \node[above=0mm of sqr.north east,color=red!80,font=\footnotesize\bf]
    {dynamic links};

    \fill[color=red!50] ([xshift=-3mm]sos.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]sos.east) -- ([xshift=4mm]sos.east)
    -- ([xshift=4mm,yshift=1mm]main.east) -- ([yshift=1mm]main.east);

    \fill[color=red!50] ([xshift=-3mm]sqr.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]sqr.east) -- ([xshift=4mm]sqr.east)
    -- ([xshift=4mm,yshift=1mm]sos.east) -- ([yshift=1mm]sos.east);

    \fill[color=red!50] ([xshift=-3mm]main.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]main.east) -- ([xshift=4mm]main.east)
    -- ([xshift=4mm]global.east) -- (global.east);

    % static links
    \node[above=0mm of sqr.north west,color=blue!50,font=\footnotesize\bf]
    {static links};

    \fill[color=blue!50] ([xshift=4mm,yshift=-2mm]sqr.north west) circle (2pt);
    \draw[->,color=blue!50] ([xshift=4mm,yshift=-2mm]sqr.north west)
    -- ([xshift=-4mm,yshift=-2mm]sqr.north west)
    -- ([xshift=-4mm]global.west) -- (global.west);

    \fill[color=blue!50] ([xshift=4mm,yshift=-2mm]sos.north west) circle (2pt);
    \draw[->,color=blue!50] ([xshift=4mm,yshift=-2mm]sos.north west)
    -- ([xshift=-4mm,yshift=-2mm]sos.north west)
    -- ([xshift=-4mm]global.west) -- (global.west);

    \fill[color=blue!50] ([xshift=4mm,yshift=-2mm]main.north west) circle (2pt);
    \draw[->] ([xshift=4mm,yshift=-2mm]main.north west)
    -- ([xshift=-2mm,yshift=-2mm]main.north west)
    -- ([xshift=-2mm]global.west) -- (global.west);

  \end{tikzpicture}
\end{minipage}
\end{itemize}
\section*{Example 2: dynamic and static links of nested procedure}
\begin{minipage}{.45\linewidth}
\begin{lstlisting}[language=c,xrightmargin=2pt]
void foo(int i) {
  int j = 3;
  void bar() {
    int j = 0, k;
    k = i + j;
  }
  bar();
}
\end{lstlisting}
\end{minipage}
\begin{minipage}{.5\linewidth}
\begin{lstlisting}[language=c,xleftmargin=2pt]
int main() {
   int x = 69;
   void baz(int x) {
     foo(x);
   }
   baz(x);
   return 0;
}
\end{lstlisting}
\end{minipage}
\begin{itemize}
\item Suppose the innermost \texttt{bar} is being executed
\end{itemize}
\begin{minipage}{\linewidth}
  \centering
  \begin{tikzpicture}
    % bar
    \node(bar) [ar,fill=green!50,fill=green!20] {
      \mb{static link} of bar \\
      args for next call \\
      bar frame ptr \\
      return addr \\
      local: j, k
    };
    \node(note0) [right=6mm of bar.south east, yshift=-5mm,
    text width=3cm,font=\footnotesize] {
      Each callee saves its caller's frame ptr as its \mo{dynamic link},
      thus this link points back to location where the caller's base ptr was
    };
    \node(note1) [below=1mm of note0, text width=3cm,font=\footnotesize] {
      Each callee's \mb{static link} points to where it's defined,
      which is its lexical scope.
    };

    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]bar.north west) -- ([xshift=-8mm]bar.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{bar} AR};

    % foo
    \node(foo) [ar,fill=blue!50,fill=blue!20,below=0mm of bar] {
      \mb{static link} of foo \\
      args for bar \\
      baz's frame ptr \\
      return addr \\
      locals: j
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]foo.north west) -- ([xshift=-8mm]foo.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{foo} AR};

    % baz
    \node(baz) [ar,fill=red!50,fill=red!20,below=0mm of foo] {
      \mb{static link} of baz\\
      args for foo: i \\
      main's frame ptr \\
      return addr \\
      locals
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]baz.north west) -- ([xshift=-8mm]baz.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{baz} AR};

    % main
    \node(main) [ar,below=0mm of baz] {
      \mb{static link} of main\\
      args for baz: x \\
      global frame ptr \\
      return addr \\
      locals: x, baz
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]main.north west) -- ([xshift=-8mm]main.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{main} AR};

    % global
    \node(global) [ar,below=0mm of main] { global: \\ main,foo };


    % dynamic links
    \node[above=0mm of bar.north east,color=red!80,font=\footnotesize\bf]
    {dynamic links};
    % bar -> foo
    \fill [color=red!50] ([xshift=-3mm]bar.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]bar.east) -- ([xshift=4mm]bar.east)
    -- ([xshift=4mm,yshift=1mm]foo.east) -- ([yshift=1mm]foo.east);

    % foo -> baz
    \fill [color=red!50] ([xshift=-3mm]foo.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]foo.east) -- ([xshift=4mm]foo.east)
    -- ([xshift=4mm,yshift=1mm]baz.east) -- ([yshift=1mm]baz.east);

    % baz -> main
    \fill [color=red!50] ([xshift=-3mm]baz.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]baz.east) -- ([xshift=4mm]baz.east)
    -- ([xshift=4mm,yshift=1mm]main.east) -- ([yshift=1mm]main.east);

    % main -> null
    \fill [color=red!50] ([xshift=-3mm]main.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]main.east) -- ([xshift=4mm]main.east)
    -- ([xshift=4mm]global.east) -- (global.east);

    % static links
    \node[above=0mm of bar.north west,color=blue!50,font=\footnotesize\bf]
    {static links};
    % bar -> foo (as bar defined in foo)
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]bar.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]bar.north west)
    -- ([xshift=-2mm,yshift=-2mm]bar.north west)
    -- ([xshift=-2mm]foo.west)
    -- (foo.west);

    % foo -> global
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]foo.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]foo.north west)
    -- ([xshift=-4mm,yshift=-2mm]foo.north west)
    -- ([xshift=-4mm]global.west)
    -- (global.west);

    % baz -> main
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]baz.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]baz.north west)
    -- ([xshift=-2mm,yshift=-2mm]baz.north west)
    -- ([xshift=-2mm]main.west)
    -- (main.west);

    % main -> global
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]main.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]main.north west)
    -- ([xshift=-4mm,yshift=-2mm]main.north west)
    -- ([xshift=-4mm]global.west)
    -- (global.west);
  \end{tikzpicture}
\end{minipage}

\section*{Example 3: nested proc, returned proc, closure}
\begin{minipage}{\linewidth}
  \centering
  \begin{tikzpicture}
    % swap
    \node(swap) [ar,fill=green!50,fill=green!20] {
      \mb{static link} of swap \\
      args for next call \\
      partition frame ptr \\
      return addr \\
      local: t
    };

    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]swap.north west) -- ([xshift=-8mm]swap.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{swap AR}};

    % partition
    \node(part) [ar,fill=blue!50,fill=blue!20,below=0mm of swap] {
      \mb{static link}: part \\
      args for bar \\
      quick2 frame ptr \\
      return addr \\
      locals: i, j, v
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]part.north west) -- ([xshift=-8mm]part.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{part AR}};

    % quick2
    \node(quick2) [ar,fill=red!50,fill=red!20,below=0mm of part] {
      \mb{static link} of quick2\\
      args for foo: i \\
      quick1 frame ptr \\
      return addr \\
      locals: \\
      swap, partition
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]quick2.north west) -- ([xshift=-8mm]quick2.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{quick\#2 AR}};

    % quick1
    \node(quick1) [ar,fill=red!50,fill=red!20,below=0mm of quick2] {
      \mb{static link} of quick1\\
      args for partition \\
      sort frame ptr \\
      return addr \\
      locals: \\
      swap, partition
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]quick1.north west) -- ([xshift=-8mm]quick1.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{quick\#1 AR}};

    % sort
    \node(sort) [ar,fill=cyan!50,fill=cyan!20,below=0mm of quick1] {
      \mb{static link} of sort\\
      args for next call \\
      global frame ptr \\
      return addr \\
      locals: show,quick
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-8mm]sort.north west) -- ([xshift=-8mm]sort.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{sort AR}};

    % global
    \node(global) [ar,below=0mm of sort] { global: \\
      nums: [1..100]int, \\
      sort, print, \\
      read\_array, \\
      write\_array
    };

    %dynamic links
    \node[above=0mm of swap.north east,color=red!80,font=\footnotesize\bf]
    {dynamic links};
    % swap -> part
    \fill[color=red!50] ([xshift=-3mm]swap.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]swap.east) -- ([xshift=4mm]swap.east)
    -- ([xshift=4mm,yshift=1mm]part.east) -- ([yshift=1mm]part.east);
    % part -> quick2
    \fill[color=red!50] ([xshift=-3mm]part.east) circle (2pt);
    \draw[->,color=red!50] ([xshift=-3mm]part.east) -- ([xshift=4mm]part.east)
    -- ([xshift=4mm,yshift=2.8mm]quick2.east) -- ([yshift=2.8mm]quick2.east);
    % quick2 -> quick1
    \fill[color=red!50] ([xshift=-3mm,yshift=1.8mm]quick2.east) circle (2pt);
    \draw[->,color=red!50]
    ([xshift=-3mm,yshift=1.8mm]quick2.east)
    -- ([xshift=4mm,yshift=1.8mm]quick2.east)
    -- ([xshift=4mm,yshift=2.8mm]quick1.east) -- ([yshift=2.8mm]quick1.east);
    % quick1 -> sort
    \fill[color=red!50] ([xshift=-3mm,yshift=1.8mm]quick1.east) circle (2pt);
    \draw[->,color=red!50]
    ([xshift=-3mm,yshift=1.8mm]quick1.east)
    -- ([xshift=4mm,yshift=1.8mm]quick1.east)
    -- ([xshift=4mm,yshift=1.6mm]sort.east) -- ([yshift=1.6mm]sort.east);
    % sort -> global
    \fill[color=red!50] ([xshift=-3mm]sort.east) circle (2pt);
    \draw[->,color=red!50]
    ([xshift=-3mm]sort.east) -- ([xshift=4mm]sort.east)
    -- ([xshift=4mm]global.east) -- (global.east);

    % static links
    \node[above=0mm of swap.north west,color=blue!50,font=\footnotesize\bf]
    {static links};
    % swap -> quick2 (as bar defined in foo)
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]swap.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]swap.north west)
    -- ([xshift=-2mm,yshift=-2mm]swap.north west)
    -- ([xshift=-2mm]quick2.west)
    -- (quick2.west);
    % part -> quick2
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]part.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]part.north west)
    -- ([xshift=-2mm,yshift=-2mm]part.north west)
    -- ([xshift=-2mm]quick2.west)
    -- (quick2.west);
    % quick2 -> sort
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]quick2.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]quick2.north west)
    -- ([xshift=-4mm,yshift=-2mm]quick2.north west)
    -- ([xshift=-4mm]sort.west)
    -- (sort.west);
    % quick1 -> sort
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]quick1.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]quick1.north west)
    -- ([xshift=-4mm,yshift=-2mm]quick1.north west)
    -- ([xshift=-4mm]sort.west)
    -- (sort.west);
    % sort -> global
    \fill[color=blue!50] ([xshift=2mm,yshift=-2mm]sort.north west) circle (2pt);
    \draw[->,color=blue!50]
    ([xshift=2mm,yshift=-2mm]sort.north west)
    -- ([xshift=-6mm,yshift=-2mm]sort.north west)
    -- ([xshift=-6mm]global.west)
    -- (global.west);
  \end{tikzpicture}
\end{minipage}

\end{multicols*}
\end{document}
