\documentclass[10pt,a4paper,landscape]{article}
\input{preamble}

\begin{document}
% Suppress page number for all pages
\pagestyle{empty}

% Each section goes into this env
\begin{multicols*}{3}
\section*{Activation Recrod (AR) and Call Stack}
\begin{itemize}
\item Each procedure has its own AR (a chunk of memory)
\item AR acts as a storage for all the necessary info about the function. It also corresponds to a scope of the function
\item Call stack is data structure used to manage ARs in many imperative langs. In such cases, AR also called \mb{stack frame}
\item Callee's \mb{dynamic link} \textbf{points back} to its caller
\item Returned procedure (its AR) should \emph{not} appear on call stack
\end{itemize}
\section*{Dynamic Link vs Static Link}
\begin{itemize}
\item Links are \mo{dynamic} because they are known only at runtime
\item a procedure's \mo{dynamic link} points to its caller
\item a procedure's \mb{static link} points to where it's \textbf{defined} (its immediate \mb{enclosing scope}, doesn't change during runtime)
\end{itemize}
\section*{Example 1: dynamic links and static links}
\begin{itemize}
\item Suppose the following two \mo{globally} defined procedures
\begin{minipage}{.5\linewidth}
\begin{lstlisting}[language=c]
int sqr(int x) {
  return x * x;
}
\end{lstlisting}
\end{minipage}
\begin{minipage}{.5\linewidth}
\begin{lstlisting}[language=c,xleftmargin=2pt]
int sos(int x, int y) {
  return sqr(x) + sqr(y);
}
\end{lstlisting}
\end{minipage}
\item \texttt{main} calls \texttt{sos} which is being executed (all vars in memory)
\begin{lstlisting}[language=c]
int main(int x) {
  int x = 3, y = 4; // assume vars stored in mem
  sos(x, y); // <-- executing sum of square
  return x * x;
}
\end{lstlisting}
\item box repr. a mem location, a ptr in it points to some other location. Ptrs in regs (\texttt{\%rbp}, \texttt{\%rsp}) may point to a location
  \begin{minipage}{\linewidth}
    \begin{tikzpicture}
      \node(ptr)[ar] {a ptr stored in mem};
      \node[right=5mm of ptr.north east,font=\footnotesize]{
        location start is pointed by a ptr in reg
      };
      \node[right=5mm of ptr.east,font=\footnotesize]{
        ptr stored in mem points to other location
      };
      \draw[->] (ptr.east) -- ([xshift=4mm]ptr.east) -- ([xshift=4mm]ptr.south east);
      \draw[->,color=red!80] ([xshift=4mm]ptr.north east) -- (ptr.north east);
    \end{tikzpicture}
  \end{minipage}
\item Draw the stack frame for \texttt{main} (stack \mr{grows upwards})
\begin{minipage}{\linewidth}
  \centering
  \begin{tikzpicture}
    % main
    \node(main) [ar] {
      static link \\
      args for callee \\
      prev frame ptr \\
      return addr \\
      locals: x, y
    };
    \node(global) [ar,below=0mm of main] { global: main };

    % main's dynamic link points to null
    \node(null) [right=4mm of main.east,font=\footnotesize]
    {\texttt{null} (no caller for \texttt{main})};
    \draw[->,color=red!80] ([xshift=-3mm]main.east) -- (null.west);

    \node(dy) [below=1mm of null, font=\footnotesize, text width=4cm] {
      \texttt{main} is outermost frame so its dynamic link points to null
      (nothing calls main)
    };

    % main's static link points to global
    \draw[->]
    ([yshift=-1mm]main.north west) -- ([xshift=-2mm,yshift=-1mm]main.north west)
    -- ([xshift=-2mm]global.west) -- (global.west);
  \end{tikzpicture}
\end{minipage}
\item Draw call stack where \texttt{main} calls \texttt{sos} (it saved \texttt{main}'s RBP)
\begin{minipage}{\linewidth}
  \centering
  \begin{tikzpicture}
    % sos
    \node(sos) [ar, fill=blue!50,fill=blue!20,above=0mm of main] {
      \mb{static link} \\
      args for callee \\
      main's frame ptr \\
      return addr \\
      local vars
    };
    \node(note1) [right=6mm of sos.south east,text width=4cm,font=\footnotesize] {
      \texttt{sos}'s \mo{dynamic link} (saved frame pointer of \texttt{main}) points to \texttt{main}'s \texttt{RBP} location };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]sos.north west) -- ([xshift=-6mm]sos.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{sos} AR};

    \node(note2) [right=6mm of sos.east, yshift=2mm, text
    width=4cm,font=\footnotesize] {
      \texttt{sos}'s frame ptr (usu. in reg) points to the start of this location
      (\texttt{main}'s frame ptr)
    };
    \draw[->,color=red!80]([yshift=-1mm]note2.west) -- ([yshift=1mm]sos.east);

    % main
    \node(main) [ar,below=0mm of sos] {
      \mb{static link} \\
      args for callee \\
      prev frame ptr \\
      return addr \\
      locals: x, y
    };

    % global
    \node(global) [ar,below=0mm of main] { global: main,sos };

    % dynamic link
    \node[above=0mm of sos.north east,font=\footnotesize,color=red!80]
    {dynamic links};
    \draw[->,color=red!50] ([xshift=-3mm]sos.east) -- ([xshift=4mm]sos.east)
    -- ([xshift=4mm,yshift=1mm]main.east) -- ([yshift=1mm]main.east);

    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]main.north west) -- ([xshift=-6mm]main.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{main} AR};

    % static links
    \node[above=0mm of sos.north west,font=\footnotesize,color=blue!50]
    {static links};
    \draw[->] ([xshift=4mm,yshift=-2mm]main.north west) --
    ([yshift=-2mm]main.north west) -- ([xshift=-2mm,yshift=-2mm]main.north west)
    -- ([xshift=-2mm]global.west) -- (global.west);

    \draw[->,color=blue!50] ([xshift=4mm,yshift=-2mm]sos.north west) --
    ([yshift=-2mm]sos.north west) -- ([xshift=-4mm,yshift=-2mm]sos.north west)
    -- ([xshift=-4mm]global.west) -- (global.west);
  \end{tikzpicture}
\end{minipage}
\item Call stack where \texttt{sos} calls \texttt{sqr} (which saved \texttt{sos}'s RBP)
\begin{minipage}{\linewidth}
  \centering
  \begin{tikzpicture}
    % sqr
    \node(sqr) [ar,fill=green!50,fill=green!20,above=0mm of sos] {
      \mb{static link} \\
      args for callee \\
      sos' frame ptr \\
      return addr \\
      local vars
    };
    \node(note0) [right=6mm of sqr.south east,text width=4cm,font=\footnotesize] {
      \texttt{sqr}'s \mo{dynamic link} (saved frame pointer of \texttt{sos}) points to start of \texttt{sos}'s \texttt{RBP} location };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]sqr.north west) -- ([xshift=-6mm]sqr.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{sqr} AR};

    % sos
    \node(sos) [ar, fill=blue!50,fill=blue!20,above=0mm of main] {
      \mb{static link} \\
      args for callee \\
      main's frame ptr \\
      return addr \\
      local vars
    };
    \node(note1) [right=6mm of sos.south east,text width=4cm,font=\footnotesize] {
      \texttt{sos}'s \mo{dynamic link} (saved frame pointer of \texttt{main}) points to start of \texttt{main}'s \texttt{RBP} location };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]sos.north west) -- ([xshift=-6mm]sos.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{sos} AR};

    % main
    \node(main) [ar,below=0mm of sos] {
      \mb{static link} \\
      args for callee \\
      prev frame ptr \\
      return addr \\
      locals: x, y
    };
    \draw[decorate,decoration={brace,mirror}]
    ([xshift=-6mm]main.north west) -- ([xshift=-6mm]main.south west)
    node[midway,sloped,below,font=\footnotesize]{\texttt{main} AR};

    % global
    \node(global) [ar,below=0mm of main] {
      global:\\
      main, sos, sqr
    };

    %dynamic links
    \node[above=0mm of sqr.north east,font=\footnotesize,color=red!80]
    {dynamic links};
    \draw[->,color=red!50] ([xshift=-3mm]sos.east) -- ([xshift=4mm]sos.east)
    -- ([xshift=4mm,yshift=1mm]main.east) -- ([yshift=1mm]main.east);
    \draw[->,color=red!50] ([xshift=-3mm]sqr.east) -- ([xshift=4mm]sqr.east)
    -- ([xshift=4mm,yshift=1mm]sos.east) -- ([yshift=1mm]sos.east);
    \draw[->,color=red!50] ([xshift=-3mm]main.east) -- ([xshift=4mm]main.east)
    -- ([xshift=4mm,yshift=2mm]main.south east);
    \node[right=0mm of main.south east,font=\footnotesize]{\texttt{null}};

    % static links
    \node[above=0mm of sqr.north west,font=\footnotesize,color=blue!50]
    {static links};
    \draw[->] ([xshift=4mm,yshift=-2mm]main.north west) --
    ([yshift=-2mm]main.north west) -- ([xshift=-2mm,yshift=-2mm]main.north west)
    -- ([xshift=-2mm]global.west) -- (global.west);

    \draw[->,color=blue!50] ([xshift=4mm,yshift=-2mm]sos.north west) --
    ([yshift=-2mm]sos.north west) -- ([xshift=-4mm,yshift=-2mm]sos.north west)
    -- ([xshift=-4mm]global.west) -- (global.west);

    \draw[->,color=blue!50] ([xshift=4mm,yshift=-2mm]sqr.north west) --
    ([yshift=-2mm]sqr.north west) -- ([xshift=-4mm,yshift=-2mm]sqr.north west)
    -- ([xshift=-4mm]global.west) -- (global.west);
  \end{tikzpicture}
\end{minipage}
\end{itemize}
\section*{Example 2: dynamic and static links of nested procedure}
\end{multicols*}
\end{document}
